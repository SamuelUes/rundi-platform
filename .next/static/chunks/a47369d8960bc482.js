(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,51993,e=>{"use strict";e.s(["typography",0,{h1:"text-2xl font-semibold",h2:"text-sm font-semibold",body:"text-sm",bodyMuted:"text-xs"}])},48268,e=>{"use strict";var s=e.i(43476),a=e.i(71645);e.i(51718);var t=e.i(18357);e.i(36180);var r=e.i(98925),l=e.i(746),i=e.i(8277),n=e.i(51993);function o(){let[e,o]=(0,a.useState)([]),[d,c]=(0,a.useState)(!0),[x,m]=(0,a.useState)(null),[p,h]=(0,a.useState)(""),[u,g]=(0,a.useState)(null),[b,y]=(0,a.useState)([]),[j,f]=(0,a.useState)(!1),[N,v]=(0,a.useState)(null),[C,w]=(0,a.useState)(null);(0,a.useEffect)(()=>{let e=(0,t.onAuthStateChanged)(l.firebaseAuth,async e=>{if(!e){m("Sesión no encontrada."),c(!1);return}try{let s=await e.getIdToken();w(s);let a=await (0,r.getDocs)((0,r.collection)(l.firestore,"users")),t={};a.forEach(e=>{let s=e.data();t[e.id]={email:s.email??null,name:s.name??null,appRole:s.role??null,phone:s.phone??null}});let i=await (0,r.getDocs)((0,r.collection)(l.firestore,"cms-users")),n={};i.forEach(e=>{let s=e.data(),a=Array.isArray(s.assigned_service_areas)?s.assigned_service_areas:[];n[e.id]={role:s.role??null,assigned_service_areas:a}});let d=Object.entries(t).map(([e,s])=>{let a=n[e];return{id:e,email:s.email,name:s.name,role:a?.role??null,assigned_service_areas:a?.assigned_service_areas??[]}}),x={};try{let e=await fetch("/api/admin/drivers",{headers:{Authorization:`Bearer ${s}`}});if(e.ok){let s=await e.json();x=Object.fromEntries((s.drivers||[]).map(e=>[e.userId,e]))}}catch{}let m=d.map(e=>{let s=t[e.id],a=x[e.id];return{...e,appRole:s?.appRole??null,phone:a?.phone??s?.phone??null,isDriver:!!a,hasDesignatedDriverService:a?.hasDesignatedDriverService??!1}});o(m),c(!1)}catch(e){m("Error al cargar usuarios del CMS."),c(!1)}});return()=>e()},[]);let S=(0,a.useMemo)(()=>{let s=p.trim().toLowerCase();return s?e.filter(e=>{let a=e.appRole?.toLowerCase()??"",t=e.isDriver?e.hasDesignatedDriverService?"conductor designado":"conductor":a||"cliente";return[e.id,e.email,e.name,e.role,e.appRole,e.phone,t,...e.assigned_service_areas].filter(Boolean).join(" ").toLowerCase().includes(s)}):e},[e,p]);async function D(e){g(e),y([]),v(null),f(!0);try{if(!C)throw Error("Token de autenticación no disponible");let s=await fetch(`/api/admin/users/${encodeURIComponent(e.id)}/cards`,{headers:{Authorization:`Bearer ${C}`}});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.error||"No se pudieron cargar las tarjetas")}let a=((await s.json()).cards||[]).map(e=>({id:e.id,brand:e.cardBrand??e.bankName??null,country:null,createdAt:e.createdAt?new Date(e.createdAt):null,expMonth:e.expirationMonth,expYear:e.expirationYear,bankname:e.bankName??null,isDefault:e.isDefault,last4:e.lastFourDigits??null,provider:e.localCardId??e.bankName??null}));y(a)}catch(e){v(e.message||"No se pudieron cargar las tarjetas")}finally{f(!1)}}return(0,s.jsxs)("section",{className:"space-y-4",children:[(0,s.jsxs)("header",{className:"space-y-1",children:[(0,s.jsx)("h1",{className:`${n.typography.h1} ${i.themeColors.textPrimary}`,children:"Usuarios y roles"}),(0,s.jsx)("p",{className:`${n.typography.body} ${i.themeColors.textSecondary}`,children:'Listado global de usuarios de la app (colección "users"), con su rol en la app, su estado como conductor/designado y, si aplica, su rol en el CMS (admin / operator).'})]}),(0,s.jsxs)("div",{className:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("input",{type:"search",value:p,onChange:e=>h(e.target.value),placeholder:"Buscar por nombre, correo, ID, teléfono, rol o área",className:`w-full rounded-xl border border-zinc-200 bg-white px-4 py-2.5 text-sm shadow-sm outline-none transition focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 ${i.themeColors.textPrimary}`}),(0,s.jsx)("p",{className:`mt-1 text-xs ${i.themeColors.textMuted}`,children:"Búsqueda sobre: nombre, correo, UID, rol CMS, rol app, teléfono y áreas asignadas."})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 text-xs",children:[(0,s.jsxs)("span",{className:"inline-flex items-center gap-1 rounded-full bg-zinc-100 px-3 py-1 font-medium text-zinc-600",children:["Usuarios totales",(0,s.jsx)("strong",{className:"text-zinc-900",children:e.length})]}),(0,s.jsxs)("span",{className:"inline-flex items-center gap-1 rounded-full bg-emerald-50 px-3 py-1 font-medium text-emerald-700",children:["Filtrados",(0,s.jsx)("strong",{children:S.length})]})]})]}),d&&(0,s.jsx)("p",{className:`${n.typography.body} ${i.themeColors.textSecondary}`,children:"Cargando usuarios..."}),!d&&x&&(0,s.jsx)("p",{className:`${n.typography.body} ${i.themeColors.dangerText}`,children:x}),!d&&!x&&(0,s.jsx)("div",{className:"overflow-x-auto rounded-2xl border border-zinc-200 bg-white shadow-sm",children:(0,s.jsxs)("table",{className:"min-w-full border-collapse text-left text-sm",children:[(0,s.jsx)("thead",{className:"bg-linear-to-r from-emerald-50 to-white text-[11px] uppercase tracking-wide text-emerald-700",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Usuario"}),(0,s.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Rol app"}),(0,s.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Rol CMS"}),(0,s.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Contacto"}),(0,s.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Áreas CMS"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right font-semibold",children:"Tarjetas"})]})}),(0,s.jsx)("tbody",{children:S.map((e,a)=>{let t=e.appRole?.toLowerCase()??"",r=e.isDriver?e.hasDesignatedDriverService?"Conductor + Designado":"Conductor":t||"Cliente",l=e.role||"Sin rol CMS",i=e.isDriver?e.hasDesignatedDriverService?"bg-emerald-100 text-emerald-700":"bg-blue-100 text-blue-700":"bg-zinc-100 text-zinc-600",n=e.role?"bg-indigo-50 text-indigo-600":"bg-zinc-100 text-zinc-500",o=e.assigned_service_areas.length?e.assigned_service_areas.join(", "):"Sin áreas asignadas";return(0,s.jsxs)("tr",{className:`${a%2==0?"bg-white":"bg-zinc-50/60"} border-b last:border-0 transition hover:bg-emerald-50/60`,children:[(0,s.jsx)("td",{className:"px-4 py-3 align-top text-xs text-zinc-700",children:(0,s.jsxs)("div",{className:"space-y-0.5",children:[(0,s.jsx)("div",{className:"text-sm font-semibold text-zinc-900",children:e.name||"(sin nombre)"}),(0,s.jsx)("div",{className:"text-[11px] text-zinc-500",children:e.email||"(sin correo)"}),(0,s.jsxs)("div",{className:"text-[11px] text-zinc-400",children:["UID: ",e.id]})]})}),(0,s.jsx)("td",{className:"px-4 py-3 align-top",children:(0,s.jsx)("span",{className:`inline-flex rounded-full px-2.5 py-0.5 text-[11px] font-semibold ${i}`,children:r})}),(0,s.jsx)("td",{className:"px-4 py-3 align-top",children:(0,s.jsx)("span",{className:`inline-flex rounded-full px-2.5 py-0.5 text-[11px] font-semibold ${n}`,children:l})}),(0,s.jsx)("td",{className:"px-4 py-3 align-top text-xs text-zinc-600",children:(0,s.jsx)("div",{children:e.phone||"(sin teléfono)"})}),(0,s.jsx)("td",{className:"px-4 py-3 align-top text-xs text-zinc-600",children:o}),(0,s.jsx)("td",{className:"px-4 py-3 align-top text-right",children:(0,s.jsx)("button",{type:"button",onClick:()=>D(e),className:"inline-flex items-center rounded-full border border-emerald-200 px-3 py-1 text-xs font-semibold text-emerald-700 transition hover:border-emerald-400 hover:bg-emerald-50",children:"Ver tarjetas"})})]},e.id)})})]})}),u&&(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:(0,s.jsxs)("div",{className:"w-full max-w-3xl rounded-lg bg-white p-5 shadow-xl",children:[(0,s.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:`${n.typography.h2} ${i.themeColors.textPrimary}`,children:"Tarjetas guardadas"}),(0,s.jsxs)("p",{className:`${n.typography.body} ${i.themeColors.textSecondary}`,children:["Usuario: ",u.name||u.email||u.id]})]}),(0,s.jsx)("button",{type:"button",onClick:function(){g(null),y([]),v(null),f(!1)},className:`rounded px-2 py-1 text-sm ${i.themeColors.textSecondary} ${i.themeColors.surfaceHover}`,children:"Cerrar"})]}),j&&(0,s.jsx)("p",{className:`${n.typography.body} ${i.themeColors.textSecondary}`,children:"Cargando tarjetas..."}),!j&&N&&(0,s.jsx)("p",{className:`${n.typography.body} ${i.themeColors.dangerText}`,children:N}),!j&&!N&&0===b.length&&(0,s.jsx)("p",{className:`${n.typography.body} ${i.themeColors.textSecondary}`,children:"No hay tarjetas guardadas para este usuario."}),!j&&!N&&b.length>0&&(0,s.jsx)("div",{className:"grid gap-4 md:grid-cols-2",children:b.map(e=>{var a;return(0,s.jsxs)("div",{className:"rounded-lg border p-3 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between text-sm font-semibold",children:[(0,s.jsxs)("span",{className:i.themeColors.textPrimary,children:[e.brand?.toUpperCase()||"Tarjeta"," ·••",e.last4||"XXXX"]}),e.isDefault&&(0,s.jsx)("span",{className:"text-xs font-medium text-emerald-600",children:"Predeterminada"})]}),(0,s.jsxs)("div",{className:`mt-1 text-xs ${i.themeColors.textSecondary}`,children:[(0,s.jsxs)("p",{children:["Proveedor: ",e.provider||"N/D"]}),(0,s.jsxs)("p",{children:["País: ",e.country||"N/D"]}),(0,s.jsxs)("p",{children:["Banco: ",e.bankname||"N/D"]}),(0,s.jsxs)("p",{children:["Expira: ",e.expMonth||"??","/",e.expYear||"????"]}),(0,s.jsxs)("p",{children:["ID: ",e.id]}),(0,s.jsxs)("p",{children:["Creada: ",!(a=e.createdAt)||Number.isNaN(a.getTime())?"Fecha no disponible":a.toLocaleString("es-NI",{dateStyle:"medium",timeStyle:"short"})]})]})]},e.id)})})]})})]})}e.s(["default",()=>o])}]);