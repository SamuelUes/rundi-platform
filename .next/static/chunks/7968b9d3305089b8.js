(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,51993,e=>{"use strict";e.s(["typography",0,{h1:"text-2xl font-semibold",h2:"text-sm font-semibold",body:"text-sm",bodyMuted:"text-xs"}])},52908,e=>{"use strict";var t=e.i(43476),s=e.i(71645);e.i(51718);var a=e.i(18357),r=e.i(746),l=e.i(8277),i=e.i(51993);function n(e){if(!e)return"N/D";let t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}function o(e){return null===e?"N/D":`${e.toFixed(2)} C$`}function d(){let[e,d]=(0,s.useState)([]),[c,x]=(0,s.useState)(!0),[m,h]=(0,s.useState)(null),[p,u]=(0,s.useState)(""),[y,j]=(0,s.useState)("requestedAt"),[f,N]=(0,s.useState)("desc"),[g,b]=(0,s.useState)(null),[v,$]=(0,s.useState)([]),[C,w]=(0,s.useState)(!1),[S,A]=(0,s.useState)(null),[I,T]=(0,s.useState)(null),[z,D]=(0,s.useState)(null);async function M(e){b(e),$([]),A(null),T(null),D(null),w(!0);try{if((e.status?.toLowerCase()==="canceled"||e.status?.toLowerCase()==="cancelled")&&!e.startedAt){D("No se realizó el viaje (cancelado antes de iniciar)."),w(!1);return}let t=r.firebaseAuth.currentUser;if(!t)throw Error("Sesión expirada. Vuelve a iniciar sesión.");let s=await t.getIdToken(),a=await fetch(`/api/admin/rides/${e.id}/route`,{headers:{Authorization:`Bearer ${s}`}});if(!a.ok){let e=await a.json().catch(()=>({}));throw Error(e.error||"No se pudo cargar la ruta")}let l=await a.json();$(l.points||[]),T(l.googleMapsApiKey??null)}catch(e){A(e instanceof Error?e.message:"Error desconocido")}finally{w(!1)}}(0,s.useEffect)(()=>{let e=(0,a.onAuthStateChanged)(r.firebaseAuth,async e=>{if(!e){h("Sesión no encontrada."),x(!1);return}try{let t=await e.getIdToken(),s=await fetch("/api/admin/rides",{headers:{Authorization:`Bearer ${t}`}});if(!s.ok){let e=(await s.json().catch(()=>({}))).error||"Error al cargar viajes.";h(e),x(!1);return}let a=await s.json();d(a.rides||[]),x(!1)}catch(e){h("Error al comunicar con el servidor."),x(!1)}});return()=>e()},[]);let P=(0,s.useMemo)(()=>{if(!I||v.length<2)return null;let e=`${v[0].lat},${v[0].lng}`,t=`${v[v.length-1].lat},${v[v.length-1].lng}`,s=v.slice(1,-1),a=s.length?`&waypoints=${encodeURIComponent(s.map(e=>`${e.lat},${e.lng}`).join("|"))}`:"";return`https://www.google.com/maps/embed/v1/directions?key=${I}&origin=${e}&destination=${t}${a}&mode=driving`},[I,v]),k=(0,s.useMemo)(()=>{let t=p.trim().toLowerCase();return[...t?e.filter(e=>[e.id,e.firebaseRideId,e.clientId,e.driverId,e.status,e.rideType,e.vehicleType,e.paymentType,e.cancelReason].filter(Boolean).join(" ").toLowerCase().includes(t)):e].sort((e,t)=>{let s=F(e,y),a=F(t,y);if(s===a)return 0;if(null==s)return"asc"===f?1:-1;if(null==a)return"asc"===f?-1:1;if("number"==typeof s&&"number"==typeof a)return"asc"===f?s-a:a-s;let r=String(s).toLowerCase(),l=String(a).toLowerCase();if(r===l)return 0;let i=r<l?-1:1;return"asc"===f?i:-i})},[e,p,y,f]);function F(e,t){if("id"===t)return e.id;if("status"===t)return e.status??null;let s="requestedAt"===t?e.requestedAt:"startedAt"===t?e.startedAt:e.completedAt;if(!s)return null;let a=new Date(s).getTime();return Number.isNaN(a)?null:a}function E(e,s){let a=y===e&&"asc"===f,r=y===e&&"desc"===f,i="leading-none text-[10px]";return(0,t.jsxs)("span",{className:"ml-1 flex flex-col",children:[(0,t.jsx)("button",{type:"button","aria-label":`Orden ascendente por ${s}`,className:`${i} ${a?l.themeColors.textPrimary:l.themeColors.textMuted}`,onClick:()=>{j(e),N("asc")},children:"▲"}),(0,t.jsx)("button",{type:"button","aria-label":`Orden descendente por ${s}`,className:`${i} ${r?l.themeColors.textPrimary:l.themeColors.textMuted}`,onClick:()=>{j(e),N("desc")},children:"▼"})]})}return(0,t.jsxs)("section",{className:"space-y-4",children:[(0,t.jsxs)("header",{className:"space-y-1",children:[(0,t.jsx)("h1",{className:`${i.typography.h1} ${l.themeColors.textPrimary}`,children:"Viajes"}),(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.textSecondary}`,children:"Historial de viajes registrado en Supabase (tabla rides)."})]}),(0,t.jsxs)("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("input",{type:"search",value:p,onChange:e=>u(e.target.value),placeholder:"Buscar por ID, cliente, conductor, estado o tipo",className:`w-full rounded-md border px-3 py-2 text-sm outline-none ring-0 ${l.themeColors.surface} ${l.themeColors.inputBorder} ${l.themeColors.textPrimary}`}),(0,t.jsx)("p",{className:`mt-1 text-xs ${l.themeColors.textMuted}`,children:"La búsqueda aplica sobre: ID de viaje, Firebase ride ID, UID de cliente, UID de conductor, estado, tipo de viaje y tipo de vehículo."})]}),(0,t.jsxs)("div",{className:"flex flex-col items-end gap-1 text-right",children:[(0,t.jsxs)("p",{className:`text-xs font-medium ${l.themeColors.textSecondary}`,children:["Total: ",k.length," viajes"]}),(0,t.jsx)("p",{className:`text-[11px] ${l.themeColors.textMuted}`,children:"Usa las flechas de cada columna para ordenar."})]})]}),c&&(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.textSecondary}`,children:"Cargando viajes..."}),!c&&m&&(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.dangerText}`,children:m}),!c&&!m&&(0,t.jsx)("div",{className:"overflow-x-auto rounded-xl border border-zinc-100 bg-white shadow-sm",children:(0,t.jsxs)("table",{className:"min-w-full text-left text-[13px]",children:[(0,t.jsx)("thead",{className:`${l.themeColors.appBackground}`,children:(0,t.jsxs)("tr",{className:"text-[11px] uppercase tracking-wide text-zinc-500",children:[(0,t.jsx)("th",{className:"px-3 py-2 font-medium",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Viaje"}),E("id","ID de viaje")]})}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium",children:"Cliente / Conductor"}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Estado"}),E("status","estado")]})}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium text-center",children:"Pasajeros"}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium",children:"Pago y montos"}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Solicitado"}),E("requestedAt","fecha solicitada")]})}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Iniciado"}),E("startedAt","fecha iniciada")]})}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Finalizado"}),E("completedAt","fecha finalizada")]})}),(0,t.jsx)("th",{className:"px-3 py-2 font-medium text-center",children:"Mapa"})]})}),(0,t.jsx)("tbody",{children:k.map(e=>(0,t.jsxs)("tr",{className:"border-b border-zinc-100 last:border-0 odd:bg-zinc-50/60",children:[(0,t.jsx)("td",{className:`px-3 py-2 align-top ${l.themeColors.textPrimary}`,children:(0,t.jsxs)("div",{className:"space-y-0.5 text-xs",children:[(0,t.jsx)("div",{className:"font-medium",children:e.id}),(0,t.jsxs)("div",{className:l.themeColors.textMuted,children:["Firebase ID: ",e.firebaseRideId||"(sin Firebase ID)"]})]})}),(0,t.jsx)("td",{className:`px-3 py-2 align-top ${l.themeColors.textSecondary}`,children:(0,t.jsxs)("div",{className:"space-y-0.5 text-xs",children:[(0,t.jsxs)("div",{children:["Cliente: ",e.clientId]}),(0,t.jsxs)("div",{children:["Conductor: ",e.driverId||"(sin asignar)"]})]})}),(0,t.jsx)("td",{className:`px-3 py-2 align-top ${l.themeColors.textSecondary}`,children:(0,t.jsxs)("div",{className:"space-y-0.5 text-xs",children:[(0,t.jsxs)("div",{children:["Estado: ",e.status||"N/D"]}),(0,t.jsxs)("div",{children:["Tipo: ",e.rideType||"normal"," / ",e.vehicleType||"auto"]})]})}),(0,t.jsx)("td",{className:`px-3 py-2 align-top text-center font-semibold ${l.themeColors.textSecondary}`,children:(0,t.jsx)("span",{className:"text-sm",children:e.passengers??"N/D"})}),(0,t.jsx)("td",{className:`px-3 py-2 align-top ${l.themeColors.textSecondary}`,children:(0,t.jsxs)("div",{className:"space-y-0.5 text-xs",children:[(0,t.jsxs)("div",{children:["Pago: ",e.paymentType||"N/D"]}),(0,t.jsxs)("div",{children:["Estimado: ",o(e.estimatedPrice)]}),(0,t.jsxs)("div",{children:["Final: ",o(e.finalFare)]}),e.cancelReason&&(0,t.jsxs)("div",{className:l.themeColors.textMuted,children:["Motivo: ",e.cancelReason]})]})}),(0,t.jsx)("td",{className:`px-3 py-2 align-top ${l.themeColors.textSecondary}`,children:(0,t.jsx)("div",{className:"text-xs font-medium",children:n(e.requestedAt)})}),(0,t.jsx)("td",{className:`px-3 py-2 align-top ${l.themeColors.textSecondary}`,children:(0,t.jsx)("div",{className:"text-xs font-medium",children:n(e.startedAt)})}),(0,t.jsx)("td",{className:`px-3 py-2 align-top ${l.themeColors.textSecondary}`,children:(0,t.jsx)("div",{className:"text-xs font-medium",children:n(e.completedAt)})}),(0,t.jsx)("td",{className:"px-3 py-2 text-center",children:(0,t.jsx)("button",{type:"button",onClick:()=>M(e),className:`inline-flex items-center rounded-md border px-3 py-1 text-xs font-medium ${l.themeColors.surfaceHover} ${l.themeColors.textSecondary}`,children:"Ver viaje"})})]},e.id))})]})}),g&&(0,t.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:(0,t.jsx)("div",{className:"h-[80vh] w-full max-w-5xl overflow-hidden rounded-2xl bg-white shadow-2xl",children:(0,t.jsxs)("div",{className:"flex h-full flex-col",children:[(0,t.jsxs)("div",{className:"mb-4 flex items-start justify-between gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:`${i.typography.h2} ${l.themeColors.textPrimary} pt-6 pl-6`,children:"Ruta del viaje"}),(0,t.jsxs)("p",{className:`${i.typography.body} ${l.themeColors.textSecondary} pl-6`,children:["Viaje ID: ",g.id]})]}),(0,t.jsx)("button",{type:"button",onClick:function(){b(null),$([]),A(null),T(null),D(null),w(!1)},className:`mr-6 mt-6 rounded-md px-3 py-1 text-sm font-medium ${l.themeColors.surfaceHover} ${l.themeColors.textSecondary}`,children:"Cerrar"})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto px-6 pb-6",children:[C&&(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.textSecondary}`,children:"Cargando ruta..."}),!C&&z&&(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.textSecondary}`,children:z}),!C&&!z&&S&&(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.dangerText}`,children:S}),!C&&!z&&!S&&0===v.length&&(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.textSecondary}`,children:"No se encontraron ubicaciones registradas para este viaje."}),!C&&!z&&!S&&v.length>0&&(0,t.jsxs)("div",{className:"space-y-5",children:[(0,t.jsx)("div",{className:"rounded-2xl border bg-gray-50/80 p-3 shadow-inner",children:P?(0,t.jsx)("iframe",{title:"Mapa del viaje",src:P,className:"h-[55vh] w-full rounded-xl border",loading:"lazy",allowFullScreen:!0}):(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.textSecondary}`,children:"No se pudo generar el mapa. Verifica que exista al menos un origen y destino y que la clave de Google Maps sea válida."})}),(0,t.jsxs)("div",{className:"rounded-2xl border bg-white/90 p-4 shadow-sm",children:[(0,t.jsxs)("div",{className:"mb-3 flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:`${i.typography.body} ${l.themeColors.textPrimary} font-semibold`,children:"Paradas registradas"}),(0,t.jsx)("p",{className:`text-xs ${l.themeColors.textSecondary}`,children:"Origen, waypoints y destino en orden cronológico"})]}),(0,t.jsx)("span",{className:"rounded-full bg-zinc-100 px-3 py-1 text-xs font-semibold text-zinc-600",children:v.length})]}),(0,t.jsx)("div",{className:"max-h-[32vh] space-y-3 overflow-y-auto pr-1",children:v.map(e=>(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-100 bg-linear-to-r from-white to-zinc-50 px-4 py-3 shadow-sm",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("p",{className:"text-xs font-semibold uppercase tracking-wide text-zinc-500",children:[e.locationType," #",e.locationOrder]}),(0,t.jsxs)("span",{className:"text-[10px] font-semibold text-zinc-400",children:[e.lat.toFixed(2),", ",e.lng.toFixed(2)]})]}),(0,t.jsx)("p",{className:`mt-1 text-sm font-medium ${l.themeColors.textPrimary}`,children:e.address||`${e.lat}, ${e.lng}`}),(0,t.jsxs)("p",{className:`text-xs ${l.themeColors.textMuted}`,children:["Lat/Lng: ",e.lat.toFixed(5),", ",e.lng.toFixed(5)]})]},e.id))})]})]})]})]})})})]})}e.s(["default",()=>d])}]);